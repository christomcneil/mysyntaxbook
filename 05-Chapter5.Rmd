# Data Visualisation
Tables and graphs, survival plots, missing values. 
## Summary Tables

### Packages needed
```{r include=FALSE}

library(arsenal) # for summary tables
library(summarytools) # for summary tables
library(gridExtra) # print multiple plots as grid
library(ggpmisc) # add formulas and p values to scatterplots
library(corrplot) #plotting correlations
library(Hmisc) #impute values
library(naniar) # deal with NAs
library(geosphere)
library(tidyverse) # data handling and viz
library(janitor) #dataframe import cleaning
library(knitr) #nice html tables
library(kableExtra) # nicer knitr tables
library(broom)
library(readr) # load csv stored data
library(geosphere) # for calc daylength
library(RColorBrewer)
library(viridis)
library(reshape2)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
          
```

### Summarise by group
```{r}
data(mtcars)
kable(mtcars %>% group_by(cyl) %>% summarise(Ave=mean(hp), StDev=sd(hp))) %>% 
  kable_styling(full_width = FALSE) %>% kable_minimal()
```

###  Summary Table - Multiple functions, variables
```{r}
# make sure brackets are correct

df.sum <- mtcars %>%  select(mpg,cyl,hp) %>%
  summarise(across(everything(),list(mean=mean,sd=sd)))
kable(df.sum,digits=2) %>% kable_styling(full_width = FALSE) %>%
  kable_minimal() # perform the analysis

df.longer <- df.sum%>% pivot_longer(col=everything(),  
names_to = c("Attribute",".value"),
  names_sep = "_")
kable(df.longer,digits=2) %>%
  kable_styling(full_width = FALSE) %>%
  kable_minimal() # pivot longer the analysis to make it readable
```
## Specific package for summary tables:
### Arsenal package


```{r, results='asis'}
tab1 <- tableby(cyl~gear+hp+wt,data=mtcars)
summary(tab1, text=TRUE, digits=2, digits.p=2, digits.pct=1)
```
### Summary tools package
```{r}
descr(mtcars, stats = c("mean", "sd"), transpose = TRUE, headings = FALSE)

kable(descr(mtcars, stats = c("mean", "sd", "n.valid"), transpose = TRUE, headings = FALSE),digits = 3) %>% 
  kable_styling(full_width = FALSE)%>% kable_minimal()
```

## Visual summary of data

Options are for markdown
```{r, results='asis'}

dfSummary(mtcars, plain.ascii = FALSE, style = "grid", 
          graph.magnif = 0.5, valid.col = FALSE, tmp.img.dir = "/tmp")
```
## Correlation matrix

### Ellipse style
```{r, fig.cap="Correlation Plot"}
corrdata <- mtcars %>% select(-c(cyl,disp,vs,am,gear,carb)) 
corr1 <- Hmisc::rcorr(as.matrix(corrdata))
M <- corr1$r
M

colnames(M) <- c("mpg", "HP", "Axle Ratio", "Weight (kPounds)", "Quarter Mile (s)")
rownames(M) <-  c("mpg", "HP", "Axle Ratio", "Weight (kPounds)", "Quarter Mile (s)")
p_mat <- corr1$P
corr <- corrplot(M, type = "upper",method="ellipse", order = "hclust", 
         p.mat = p_mat, sig.level = 0.05, insig = "blank")
```

* Red is -ve correlation
* Blue is + ve correlation
* Blank is no correlation

[Reference](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html)



## Graphing
### Frequency Histogram - basic
```{r}
plot1 <- mtcars %>% ggplot(aes(qsec))+geom_histogram()
plot1
```
### Frequency Histogram + normal distribution
```{r}
plot1 <- mtcars %>% ggplot(aes(qsec))
plot1+geom_histogram()
# add normal plot
plot1 + geom_histogram(aes( y=..density..))+
  stat_function(fun = dnorm, args = list(mean =mean(mtcars$qsec), sd=sd(mtcars$qsec))) + 
  theme_bw()
# ..density.. changes y axis to density, not count. stat function defines normal line based on data provided.
```
### multiple plot of all distributions

```{r}
mtcars %>% keep(is.numeric) %>% gather() %>% ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") + geom_histogram()
```

### x*y scatterplot with linear regression or polynomial regression
```{r echo=TRUE}
plot2<- mtcars %>% ggplot(aes(x=wt,y=qsec))
plot2a <- plot2 +geom_point()+stat_smooth(method='lm',formula=y~x) + theme_bw()
plot2b <- plot2 +geom_point()+stat_smooth(method='lm',formula = y ~ poly(x, 2)) + theme_bw()
plot2c <- plot2 +geom_point()+stat_smooth(method='lm',formula = y ~ poly(x, 3)) + theme_bw()
plot2d <- plot2 +geom_point()+stat_smooth(method='lm',formula = y ~ poly(x, 4)) + theme_bw()

grid.arrange(plot2a,plot2b,plot2c,plot2d,nrow=2,ncol=2)
```

### Add formula to plot.
```{r}
my.formula <- y ~ x
a <- plot2 +geom_point()+geom_smooth(method='lm',formula=my.formula)+
  stat_poly_eq(formula = my.formula, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE) +
  theme_bw()

my.formula2 <- y ~ poly(x, 2)
b <- plot2 +geom_point()+geom_smooth(method='lm',formula=my.formula2)+
  stat_poly_eq(formula = my.formula2, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), parse = TRUE) +
  theme_bw()

grid.arrange(a,b,nrow=1)
```

### Raincloud plots (ggplot)
```{r}
library(plyr)
library(dplyr)
```

#### custom theme creation
```{r}
theme_rain = theme(
text = element_text(size = 10),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
axis.text = element_text(size = 14),
axis.text.x = element_text(angle = 0, vjust = 0.5),
legend.title=element_text(size=16),
legend.text=element_text(size=16),
legend.position = "right",
plot.title = element_text(lineheight=.8, face="bold", size = 16),
panel.border = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))
```

#### make summary functions
```{r}
lb <- function(x) mean(x) - sd(x)
ub <- function(x) mean(x) + sd(x)
```

#### row names as real column
```{r}
mtcars <- tibble::rownames_to_column(mtcars, "car_name")
mtcars <- mtcars %>% mutate(cyl=as_factor(cyl))
```
#### calc summary data
```{r}
data("diamonds")
sumld<- ddply(diamonds, ~cut, summarise, mean = mean(carat), median = median(carat), lower = lb(carat), upper = ub(carat))
head(sumld)
```

### raincloud plot (diamonds)
```{r}


g <- ggplot(data = diamonds, aes(y = carat, x = cut, fill = cut)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .3) +
geom_point(aes(y = carat, color = cut), position = position_jitter(width = .15), size = .5, alpha = 0.3) +
geom_boxplot(width = .2, guides = FALSE, outlier.shape = NA, alpha = 0.9) +
expand_limits(x = 5.25) +
scale_color_viridis_d() +
scale_fill_viridis_d() +
coord_flip() +
theme_bw() +
theme_rain

g

```
### Alternative raincloud

```{r}
#calculations needed
sumld<- ddply(diamonds, ~cut, summarise, mean = mean(carat), median = median(carat), lower = lb(carat), upper = ub(carat))

g <- ggplot(data = diamonds, aes(y = carat, x = cut, fill = cut)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
geom_point(aes(y = carat, color = cut), position = position_jitter(width = .15), size = .5, alpha = 0.8) +
geom_point(data = sumld, aes(x = cut, y = mean), position = position_nudge(x = 0.3), size = 2.5) +
geom_errorbar(data = sumld, aes(ymin = lower, ymax = upper, y = mean), position = position_nudge(x = 0.3), width = 0) +
expand_limits(x = 5.25) +
guides(fill = FALSE) +
guides(color = FALSE) +
scale_color_viridis_d() +
scale_fill_viridis_d() +
theme_bw() +
theme_rain

g
```








