# Collection of useful R syntax and methods {#Title}
## Introduction

**This document is a collection of useful code for Rmarkdown and R**
### Structure of collection

* Rmarkdown
  + formatting basics
* Rstudio 
  + load/unload packages
  + print figures to files
* Libraries/packages
  + essential/useful packaged
* data wrangling
  + load dataset (and basic cleaning)
  + clean environment
  + check for duplicates
* data restructuring
  + Merging datasheets (add variables)
  + Merging datasets (add rows)
  + Reshaping - Converting to longer or shorter format
* data manipulation (creating new variables)
  + recode factors
  + dealing with missing data
  + Data reduction with PCA
  + Data standardisation
  
* statistical analysis – basic
* statistical analysis - advanced
* Tables
* Graphs and Plots
**I will use the mtcars dataset as much as possible**


## RMarkdown
### Formatting basics
'***' on it own, for a horizontal line
'**text**' for **bold**
'*text*' for *italics*
'1. Item 1
2. Item 2
3. Item 3
    + Item 3a
    + Item 3b' for ordered lists
    
'[linked phrase](http://example.com)' for links
 '![alt text](figures/img.png)' for images

### R chunk basics 
'message=FALSE, warning=FALSE, include=FALSE, ECHO=FALSE (show output), '

To set document default 'knitr::opts_chunk$set(echo=FALSE)' for example

## Rstudio
### Useful packages
Load all libraries
```{r}
library(tidyverse) # data handling and viz
library(janitor) #dataframe import cleaning
library(knitr) #nice html tables
library(kableExtra) # nicer knitr tables
library(broom)
```
### Remove a package (library)
```{r}
#Unload a module: 
library(clipr) #load
detach(package:clipr) #unload
```

## Loading and manipulating packages and data frames
### Data importing using Janitor
```{r}
# Create a data.frame with dirty names
test_df <- as.data.frame(matrix(ncol = 6))
names(test_df) <- c("firstName", "ábc@!*", "% successful (2009)",
                    "REPEAT VALUE", "REPEAT VALUE", "")
head(test_df)
test_df <- test_df %>%
  clean_names()
head(test_df)
```
Reference [here](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html)

### Remove dataframe from environment:### 
```{r}
data("mtcars")
data("band_instruments")
data("band_instruments2") # Load example datasets

rm(list=ls()[! ls() %in% c("band_instruments","band_instruments2")]) # Everything except Band instruments
rm(list=setdiff(ls(), "band_instruments")) # Everything except "bandinstruments"
rm(list=ls()) # Remove everything
```
Reference:
[Stackoverflow](https://stackoverflow.com/questions/6190051/how-can-i-remove-all-objects-but-one-from-the-workspace-in-r)




### Recode a text variable
*Tidyverse libraries are needed for the following examples.*
```{r message=FALSE}
data("band_members")
kable(head(band_members)) %>% kable_minimal(full_width = F)
band_members <- band_members %>% mutate(name=recode(name, "Mick"= "m"))
kable(head((band_members))) %>% kable_minimal(full_width = F)
rm(list=ls()) # Remove everything
```
Reference for table formatting
[Kable Extra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

### Altering variable names:
*Remove all underscores from names*
```{r}
data("mtcars")
mtcars <- mtcars %>% rename(hp_new=hp)
kable(head((mtcars))) %>% kable_minimal(full_width = F)

mtcars <- mtcars %>% rename_with(.fn = ~str_replace(., "_", ""))
kable(head((mtcars))) %>% kable_minimal(full_width = F)

```


## Data manipulation

### Bin variable  ( e.g. Low/Medium/High)
```{r}
data(mtcars)
mtcars <- mtcars %>% mutate(hp_cat=cut(hp, breaks=c(-Inf, 100, Inf), 
                                       labels=c("low hp","high hp")))
```

### Perform conditional function
```{r}
mtcars <- mtcars %>% mutate(loghp=ifelse(cyl>4,log10(hp),NA)) 
# Nonsensical example, but log transformed all horse powers of cars with more
# than four cylinders
```

### Calculate sum of values across rows
```{r}
mtcars <- mtcars %>%  mutate(sum = select(., disp:drat) %>% 
apply(1, sum, na.rm=TRUE))
#apply() takes Data frame or matrix as an input and gives output in vector 
#(i.e.many columns to one list)
# the '1' sets the dataframe to use (already selected here)

```
[Reference for summation across rows](https://stackoverflow.com/questions/28873057/sum-across-multiple-columns-with-dplyr)

### Standardise variable (mean of 0, SD of 1)
```{r stardardise variable 1}

dat2 <- mtcars %>%
    as_tibble() %>%
    mutate(across(where(is.numeric), scale))

funcs <- list(mean = ~mean(.x,na.rm = TRUE), 
  sd = ~sd(.x,na.rm = TRUE)
)
dat2 %>% summarise(across(where(is.numeric),funcs))

```
### Conditional Replacements
*Replace all 'NA's in a specified variable with 0.*
```{r}
mtcars <- mtcars %>% mutate(loghp1 = coalesce(loghp, 0))
#or
mtcars <- mtcars %>% mutate(loghp = replace_na(loghp, "missing"))
```

### Filter individuals with na's in  specified variable, or retain complete cases
```{r}
mtcars <- mtcars %>% filter(!is.na(hp)) # no missing values found
mtcars <- mtcars %>%filter(complete.cases(.)) # no missing values found
```

### Delete specified columns
```{r}
mtcars1 <- mtcars %>% select(-(drat)) # single column
mtcars2 <- mtcars %>% select(-c(drat,hp,vs:gear)) # multiple columns

rm(list=setdiff(ls(), "mtcars")) # clean environment
```

### Find duplicate rows (e.g. duplicated participant datasets)
```{r}
# specify which variable to check for duplication
n_occur1 <- data.frame(table(mtcars$mpg)) 
kable(n_occur1[n_occur1$Freq > 1,]) %>% kable_styling(full_width = F) %>% kable_minimal()
```
### Keep Distinct rows only based on a value (for example the prescription code)  using dplyr
```{r}
mtcarsdistinct <- mtcars %>% 	distinct(cyl, .keep_all= TRUE)
```
[Reference](http://www.datasciencemadesimple.com/remove-duplicate-rows-r-using-dplyr-distinct-function)

### Delete rows (individuals) based on value of a variable
```{r}
mtcars1<-mtcars %>% filter(!(cyl==6))
mtcars2<-mtcars %>% filter(!(cyl==6 | hp==180)) # | is the 'or' operator
mtcars3<-mtcars %>% filter(!(cyl==8 & hp==215)) # & is the 'and' operator
# remove the ! To select the individuals with the specified conditions
```

### Use if else to calculate based on values
```{r}
# no NA's so all values unchanged.
mtcars <- mtcars %>% mutate(vs=ifelse(is.na(vs),(carb-am)/365.25,vs)) 
```

### Merge data frames by adding variables
*left_join(x, y): returns all rows from x, and all columns from x and y. Rows in   x with no match in y will have NA values in the new columns. If there are multiple matches between x and y, all   combinations of the matches are returned.

inner_join(x, y): returns all rows from x where there are matching values in y,   and all columns from x and y. If there are multiple matches between x and y, all combinations of the matches are returned.

full_join(x, y): returns all rows and all columns from both x and y. Where there are not matching values, the function returns NA for the one missing*

* inner: only rows with matching keys in both x and y
* left: all rows in x, adding matching columns from y
* right: all rows in y, adding matching columns from x
* full: all rows in x with matching columns in y, then the rows of y that don't match x.

```{r}
#prepare new dataset
# make the rownames into a 'joinable' column
mtcars <- mtcars %>% mutate(carnames=rownames(mtcars)) 
mtcars_extradata <- mtcars %>% select(cyl)
# make the rownames into a 'joinable' column
mtcars_extradata <- mtcars_extradata %>%
mutate(carnames=rownames(mtcars_extradata)) 
mtcars_extradata <- mtcars_extradata %>% mutate(valves=cyl*4)
mtcars_extradata <- mtcars_extradata %>% select(-cyl)

kable(glimpse(mtcars_extradata%>% slice(1:6))) %>%  
  kable_styling(full_width = F) %>%
  kable_minimal()

mtcars <- left_join(mtcars,mtcars_extradata,by = 'carnames')

kable(glimpse(mtcars %>%select(carb:valves) %>%  slice(1:6))) %>% kable_styling(full_width = F) %>%
  kable_minimal()

```


### Merge data frames by adding individuals not variables
```{r}
mtcarsmerged <- bind_rows(mtcars2, mtcars3)
rm(list=setdiff(ls(), "mtcars")) # clean environment
```
[Reference](https://dplyr.tidyverse.org/reference/bind.html)

### Create a new factor from existing factors
```{r}
mtcars <- mtcars %>% mutate(cyc_carb = paste(cyl,carb,sep="-"))
```

## Statistical Methods

### Linear Regression

### Summarise and perform linear regression on multiple groups
```{r}
kable(mtcars %>%  group_by(as.factor(gear)) %>%
summarise(mean = mean(qsec), sd = sd(qsec))) %>%
  kable_styling(full_width = F) %>%
  kable_minimal()

#Rrun the same linear regression model by group levels? 
#Instead of running #summary(lm(y~x)) for the number of levels 
#you have, you can use the R package “broom” along with dplyr.

# Run the same regression model for gears ##
kable(mtcars%>% group_by(gear) %>%
  do(fitgear = glance(lm(hp~qsec, data = .))) %>% 
  unnest(fitgear),digits=2) %>%   kable_styling(full_width = F) %>% 
  kable_minimal()
```

[Reference](https://stackoverflow.com/questions/22713325/fitting-several-regression-models-with-dplyr)

### Summary Tables
Summarise by group
```{r}
kable(mtcars %>% group_by(cyl) %>% summarise(Ave=mean(hp), StDev=sd(hp))) %>% 
  kable_styling(full_width = FALSE) %>% kable_minimal()
```
###Summarise multiple functions across several variables

```{r}
# make sure brackets are correct

df.sum <- mtcars %>%  select(mpg,cyl,hp) %>%
  summarise(across(everything(),list(mean=mean,sd=sd)))
kable(df.sum,digits=2) %>% kable_styling(full_width = FALSE) %>% kable_minimal()

df.longer <- df.sum%>% pivot_longer(col=everything(),  
names_to = c("Attribute",".value"),
  names_sep = "_")
kable(df.longer,digits=2) %>% kable_styling(full_width = FALSE) %>% kable_minimal()
```






